<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>The Abuse of Exception Handlers - The Reverser&#39;s Draft</title><meta name="author" content="moval0x1">
<meta name="description" content="How Exception Handlers can be abused in low-level stuff"><meta name="keywords" content='Malware, Reversing'>
  <meta itemprop="name" content="The Abuse of Exception Handlers">
  <meta itemprop="description" content="How Exception Handlers can be abused in low-level stuff">
  <meta itemprop="datePublished" content="2024-06-26T18:20:43-03:00">
  <meta itemprop="dateModified" content="2024-06-26T18:20:43-03:00">
  <meta itemprop="wordCount" content="1443">
  <meta itemprop="image" content="https://moval0x1.github.io/logo.png">
  <meta itemprop="keywords" content="Malware,Reversing"><meta property="og:url" content="https://moval0x1.github.io/posts/the-abuse-of-exception-handlers/">
  <meta property="og:site_name" content="The Reverser&#39;s Draft">
  <meta property="og:title" content="The Abuse of Exception Handlers">
  <meta property="og:description" content="How Exception Handlers can be abused in low-level stuff">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-26T18:20:43-03:00">
    <meta property="article:modified_time" content="2024-06-26T18:20:43-03:00">
    <meta property="article:tag" content="Malware">
    <meta property="article:tag" content="Reversing">
    <meta property="og:image" content="https://moval0x1.github.io/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://moval0x1.github.io/logo.png">
  <meta name="twitter:title" content="The Abuse of Exception Handlers">
  <meta name="twitter:description" content="How Exception Handlers can be abused in low-level stuff">
      <meta name="twitter:site" content="@moval0x1">
<meta name="twitter:creator" content="@moval0x1" /><meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://moval0x1.github.io/posts/the-abuse-of-exception-handlers/" title="The Abuse of Exception Handlers - The Reverser&#39;s Draft" /><link rel="prev" type="text/html" href="https://moval0x1.github.io/posts/qakbot-analysis/" title="Qakbot Analysis" /><link rel="next" type="text/html" href="https://moval0x1.github.io/posts/automating-tasks-with-x64dbg-scripts/" title="Automating Tasks With x64dbg Scripts" /><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "The Abuse of Exception Handlers",
    "inLanguage": "en-us",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/moval0x1.github.io\/posts\/the-abuse-of-exception-handlers\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/moval0x1.github.io\/images\/profile.jpg",
              "width":  457 ,
              "height":  457 
            }],"genre": "posts","keywords": "Malware, Reversing","wordcount":  1443 ,
    "url": "https:\/\/moval0x1.github.io\/posts\/the-abuse-of-exception-handlers\/","datePublished": "2024-06-26T18:20:43-03:00","dateModified": "2024-06-26T18:20:43-03:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "moval0x1"
      },"description": "How Exception Handlers can be abused in low-level stuff"
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="The Reverser&#39;s Draft"><span class="header-title-text">The Reverser&#39;s Draft</span></a><span class="typeit header-subtitle"><template>Coding &amp; Malware &amp; Reverse Engineering</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/"><i class="fa-solid fa-file-lines fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a class="menu-link" href="/about/"><i class="fa-solid fa-solid fa-user fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="The Reverser&#39;s Draft"><span class="header-title-text">The Reverser&#39;s Draft</span></a><span class="typeit header-subtitle"><template>Coding &amp; Malware &amp; Reverse Engineering</template></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/"><i class="fa-solid fa-file-lines fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item"><a class="menu-link" href="/about/"><i class="fa-solid fa-solid fa-user fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>The Abuse of Exception Handlers</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="/about" title="Author" rel=" author" class="author"><img class="avatar" src='/images/profile.jpg' alt="moval0x1" height="16" width="16">&nbsp;moval0x1</a></span><span class="post-included-in">&nbsp;included in <a href="/categories/reversing/" class="post-category" title="Category - Reversing"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Reversing</a></span></div><div class="post-meta-line"><span title="published on 2024-06-26 18:20:43"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-06-26">2024-06-26</time></span>&nbsp;<span title="1443 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 1500 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>7 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#the-definition">The Definition</a></li>
    <li><a href="#what-is-seh-structured-exception-handler-">What is SEH (Structured Exception Handler) ?</a></li>
    <li><a href="#a-glance-example-of-seh">A glance example of SEH</a></li>
    <li><a href="#a-malware-approach-to-seh">A Malware Approach to SEH</a></li>
    <li><a href="#what-is-addvectoredexceptionhandler">What is AddVectoredExceptionHandler?</a>
      <ul>
        <li><a href="#so-what-is-the-difference">So, what is the difference?</a></li>
      </ul>
    </li>
    <li><a href="#abusing-addvectoredexceptionhandler">Abusing AddVectoredExceptionHandler</a>
      <ul>
        <li><a href="#the-beginning">The beginning</a></li>
        <li><a href="#the-debugger-view">The Debugger View</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="the-definition"><span>The Definition</span>
  <a href="#the-definition" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Everyone interested in programming probably has run into the too-famous &ldquo;try-catch&rdquo; thing. It is not something new. So, it is basically what we will talk about today. I used to say that it is always good to understand what happens behind the scenes; I mean, speaking about try-catch, it is nothing mysterious; it is kind of easy and simple to understand. But most of the time, we are talking about the surface of this, we are not digging into the details. If you would like to get the &ldquo;core&rdquo; of details, it is time to stop being only on the surface of this and take a look at the structure behind it. To start, let&rsquo;s define what it <em>Exception Handling</em>.</p>
<blockquote>
<p><em>The <a href="https://en.wikipedia.org/wiki/Exception_handling"target="_blank" rel="external nofollow noopener noreferrer"><strong>definition</strong></a> of an exception is based on the observation that each procedure has a precondition, a set of circumstances for which it will terminate &ldquo;normally&rdquo;.<a href="https://en.wikipedia.org/wiki/Exception_handling#cite_note-Cristian-1"target="_blank" rel="external nofollow noopener noreferrer">¹</a> An exception handling mechanism allows the procedure to raise an exception<a href="https://en.wikipedia.org/wiki/Exception_handling#cite_note-FOOTNOTEGoodenough1975b683%E2%80%93684-2"target="_blank" rel="external nofollow noopener noreferrer">²</a> if this precondition is violated,<a href="https://en.wikipedia.org/wiki/Exception_handling#cite_note-Cristian-1"target="_blank" rel="external nofollow noopener noreferrer">¹</a> for example if the procedure has been called on an abnormal set of arguments. The exception handling mechanism then handles the exception.<a href="https://en.wikipedia.org/wiki/Exception_handling#cite_note-FOOTNOTEGoodenough1975b684-3"target="_blank" rel="external nofollow noopener noreferrer">³</a></em></p>
</blockquote>
<h2 class="heading-element" id="what-is-seh-structured-exception-handler-"><span>What is SEH (Structured Exception Handler) ?</span>
  <a href="#what-is-seh-structured-exception-handler-" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Structured Exception Handling <strong>(SEH)</strong> is a mechanism in Windows operating systems that handles exceptions, such as errors or unexpected events, that occur during the execution of a program. <strong>SEH</strong> allows a program to respond to these exceptions in a controlled manner, ensuring that the system remains stable and providing a way to handle errors gracefully.</p>
<p>According to <a href="https://learn.microsoft.com/en-us/cpp/cpp/structured-exception-handling-c-cpp?view=msvc-170#remarks"target="_blank" rel="external nofollow noopener noreferrer"><strong>Microsoft</strong></a>, with <strong>SEH</strong>, you can ensure that resources, such as memory blocks and files, get released correctly if execution unexpectedly terminates. You can also handle specific problems—for example, insufficient memory—by using concise structured code that doesn&rsquo;t rely on goto statements or elaborate testing of return codes.</p>
<p>As mentioned, <strong>SEH</strong> functions manage exceptions in a program but it can be exploited by <strong>malware</strong> to <em>deceive disassemblers</em> and <em>complicate code analysis</em>. One technique uses the <em>FS segment</em> register to access the Thread Environment Block <strong>(TEB)</strong>, which contains a pointer to the <strong>SEH</strong> chain. The <strong>SEH</strong> chain functions like a stack, with the most recently added function executing during an exception. By manipulating this chain, malware authors can obfuscate their code, making it <strong>difficult</strong> for analysts to identify and <strong>understand malicious behavior</strong>.</p>
<h2 class="heading-element" id="a-glance-example-of-seh"><span>A glance example of SEH</span>
  <a href="#a-glance-example-of-seh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>We can see how it works by getting this simple example, compiling it, and looking at IDA and x64dbg.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">myFunction</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> p <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__except</span> (EXCEPTION_EXECUTE_HANDLER) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;An exception occurred!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    myFunction();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>The graph view of IDA.</p>
<p><figure><a class="lightgallery" href="/images/exceptionHandlers/ida-seh-graph.png" title="IDA SEH Graph" data-thumbnail="/images/exceptionHandlers/ida-seh-graph.png" data-sub-html="<h2>IDA SEH Graph</h2><p>IDA SEH Graph</p>"><img loading="lazy" src='/images/exceptionHandlers/ida-seh-graph.png' alt="IDA SEH Graph" height="561" width="1717"></a><figcaption class="image-caption">IDA SEH Graph</figcaption>
  </figure></p>
<p>The x64dbg view.</p>
<p><figure><a class="lightgallery" href="/images/exceptionHandlers/x64dbg-seh-disassembly.png" title="x64dbg SEH disassembly" data-thumbnail="/images/exceptionHandlers/x64dbg-seh-disassembly.png" data-sub-html="<h2>x64dbg SEH disassembly</h2><p>x64dbg SEH disassembly</p>"><img loading="lazy" src='/images/exceptionHandlers/x64dbg-seh-disassembly.png' alt="x64dbg SEH disassembly" height="310" width="1335"></a><figcaption class="image-caption">x64dbg SEH disassembly</figcaption>
  </figure></p>
<h2 class="heading-element" id="a-malware-approach-to-seh"><span>A Malware Approach to SEH</span>
  <a href="#a-malware-approach-to-seh" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>This code below was created to show a way to make a simple custom exception and abuse the SEH if a debugger was detected (another straightforward trick, ya?). Looking at it with our reversing tools, we can see that magic happens. Even in the future, if you need to deal with an obfuscated or packed code, You will for sure remember the basics that you saw here :D</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Function to be executed after the exception
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RedirectedExecution</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">[x] Executed after the exception</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LONG WINAPI <span style="color:#a6e22e">CustomExceptionHandler</span>(PEXCEPTION_POINTERS pExceptionInfo)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;[x] Exception code: 0x%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pExceptionInfo<span style="color:#f92672">-&gt;</span>ExceptionRecord<span style="color:#f92672">-&gt;</span>ExceptionCode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Modify the instruction pointer (EIP) to jump to the redirected execution
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pExceptionInfo<span style="color:#f92672">-&gt;</span>ContextRecord<span style="color:#f92672">-&gt;</span>Eip <span style="color:#f92672">=</span> (DWORD_PTR)RedirectedExecution;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> EXCEPTION_CONTINUE_EXECUTION;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">CheckDebuggerAndTriggerException</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (IsDebuggerPresent())
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">__try</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Cause an exception to occur (divide by zero)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">int</span> zero <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> zero;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">__except</span> (CustomExceptionHandler(GetExceptionInformation()))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">[-] Divide by Zero Exception handled by the __except block.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">[+] No debugger detected. Normal execution continues.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	CheckDebuggerAndTriggerException();
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;[+] Program executed successfully.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>In the code above we are using the <a href="https://learn.microsoft.com/en-us/windows/win32/debug/getexceptioninformation"target="_blank" rel="external nofollow noopener noreferrer"><strong>GetExceptionInformation</strong></a>, which provides the function with the exception information structure, allowing it to both read and modify the details.</p>
<h2 class="heading-element" id="what-is-addvectoredexceptionhandler"><span>What is AddVectoredExceptionHandler?</span>
  <a href="#what-is-addvectoredexceptionhandler" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/debug/vectored-exception-handling"target="_blank" rel="external nofollow noopener noreferrer"><strong>Vectored exception handlers</strong></a> are an <strong>extension</strong> to <em>structured exception handling</em>. An application can register a function to watch or handle all exceptions for the application. Vectored handlers are not frame-based, therefore, you can add a handler that will be called regardless of where you are in a call frame. Vectored handlers are called in the order that they were added, after the debugger gets a first chance notification, but before the system begins unwinding the stack.</p>
</blockquote>
<h3 class="heading-element" id="so-what-is-the-difference"><span>So, what is the difference?</span>
  <a href="#so-what-is-the-difference" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>Structured exception handling (SEH</strong>) and <strong>Vectored Exception Handling (VEH)</strong> are both mechanisms in Windows for handling exceptions, but they serve different purposes:</p>
<ul>
<li>
<p><strong>SEH</strong>:</p>
<ul>
<li>It is a Microsoft extension to C and C++ that allows graceful handling of exceptional situations, such as hardware faults.</li>
<li>It provides complete control over exception handling and is usable across all programming languages and machines.</li>
<li>It is typed, meaning different exception types can be caught and handled differently.</li>
<li>It uses stack unwinding to properly handle both user exceptions (C++ exceptions) and OS exceptions.</li>
<li>It has <strong>&ldquo;first-chance&rdquo;</strong> handling, allowing you to log or handle exceptions before unwinding destroys local variables.</li>
<li>SEH is recommended for specific scenarios where fine-grained control is needed.</li>
</ul>
</li>
<li>
<p><strong>VEH</strong>:</p>
<ul>
<li>It is an extension to SEH introduced in Windows XP.</li>
<li>It allows an application to register a function to watch or handle all exceptions for the entire application.</li>
<li>Unlike SEH, VEH handlers are <strong>not</strong> <em>frame-based</em>, so they can be called regardless of the call frame.</li>
<li>VEH handlers have <strong>priority</strong> over SEH handlers.</li>
<li>VEH is useful for scenarios where you need to intercept exceptions globally, such as debugging or logging purposes.</li>
</ul>
</li>
</ul>
<p>In summary, <strong>SEH</strong> provides fine-grained control over exception handling, while <strong>VEH</strong> allows global exception monitoring. <em>&ldquo;It is neither better nor worst, it is just different&rdquo;</em>. (MC Marcinho - <a href="https://youtu.be/hKbcorS8deY?si=i3OL2RKA_rP_27Vo"target="_blank" rel="external nofollow noopener noreferrer">Nem Melhor Nem Pior</a>)</p>
<h2 class="heading-element" id="abusing-addvectoredexceptionhandler"><span>Abusing AddVectoredExceptionHandler</span>
  <a href="#abusing-addvectoredexceptionhandler" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 class="heading-element" id="the-beginning"><span>The beginning</span>
  <a href="#the-beginning" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><figure><a class="lightgallery" href="/images/exceptionHandlers/img-gandalf.png" title="Gandalf" data-thumbnail="/images/exceptionHandlers/img-gandalf.png" data-sub-html="<h2>Gandalf</h2><p>Gandalf</p>"><img loading="lazy" src='/images/exceptionHandlers/img-gandalf.png' alt="Gandalf" height="1080" width="1920"></a><figcaption class="image-caption">Gandalf</figcaption>
  </figure></p>
<p>Let&rsquo;s start with some malware that abuses the <strong>VEH</strong>.</p>
<ul>
<li><a href="https://securityscorecard.com/research/deep-dive-into-alphv-blackcat-ransomware/"target="_blank" rel="external nofollow noopener noreferrer">ALPHV/BlackCat Ransomware</a></li>
<li><a href="https://unit42.paloaltonetworks.com/guloader-variant-anti-analysis/"target="_blank" rel="external nofollow noopener noreferrer">Guloader</a></li>
<li><a href="https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain/"target="_blank" rel="external nofollow noopener noreferrer">Dridex</a></li>
</ul>
<p>How can it be abused? Let&rsquo;s take a simple example here and look inside the debugger.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>LPVOID allocateMemory <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> shellCode[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x90</span>,							<span style="color:#75715e">// nop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0xB0</span>, <span style="color:#ae81ff">0x01</span>,						<span style="color:#75715e">// mov al, 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#ae81ff">0xC3</span>							<span style="color:#75715e">// ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#a6e22e">Handler</span>(PEXCEPTION_POINTERS exception_ptr) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (exception_ptr<span style="color:#f92672">-&gt;</span>ExceptionRecord<span style="color:#f92672">-&gt;</span>ExceptionCode <span style="color:#f92672">==</span> EXCEPTION_ACCESS_VIOLATION) {
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">[-] EXCEPTION_ACCESS_VIOLATION</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Set new EIP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		exception_ptr<span style="color:#f92672">-&gt;</span>ContextRecord<span style="color:#f92672">-&gt;</span>Eip <span style="color:#f92672">=</span> (DWORD)allocateMemory;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Enables single-step mode for the processor. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// In single-step mode, the processor generates a debug exception 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// (INT 1) after executing each instruction.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		exception_ptr<span style="color:#f92672">-&gt;</span>ContextRecord<span style="color:#f92672">-&gt;</span>EFlags <span style="color:#f92672">|=</span> <span style="color:#ae81ff">0x100</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> EXCEPTION_CONTINUE_EXECUTION;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> EXCEPTION_CONTINUE_SEARCH;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;[+] Starting VEH example...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	allocateMemory <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>VirtualAlloc(
</span></span><span style="display:flex;"><span>		NULL, 
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">sizeof</span>(shellCode), 
</span></span><span style="display:flex;"><span>		MEM_COMMIT <span style="color:#f92672">|</span> MEM_RESERVE, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	memcpy_s(allocateMemory, <span style="color:#66d9ef">sizeof</span>(shellCode), shellCode, <span style="color:#66d9ef">sizeof</span>(shellCode));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Add the handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">::</span>AddVectoredExceptionHandler(TRUE, (PVECTORED_EXCEPTION_HANDLER)Handler);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Access Violation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> p <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>In the code above, the dereferencing the null pointer will cause an <strong>ACCESS_VIOLATION</strong> which should be caught by our <em>VEH</em>. When you call the <strong><a href="https://learn.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-addvectoredexceptionhandler"target="_blank" rel="external nofollow noopener noreferrer">AddVectoredExceptionHandler</a></strong>, you need two parameters.</p>
<pre tabindex="0"><code>PVOID AddVectoredExceptionHandler(
  ULONG                       First,
  PVECTORED_EXCEPTION_HANDLER Handler
);</code></pre><p>As in the example above, the Handler type is a <strong><a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/nc-winnt-pvectored_exception_handler"target="_blank" rel="external nofollow noopener noreferrer">PVECTORED_EXCEPTION_HANDLER</a></strong></p>
<pre tabindex="0"><code>PVECTORED_EXCEPTION_HANDLER PvectoredExceptionHandler;

LONG PvectoredExceptionHandler(
 [in] _EXCEPTION_POINTERS *ExceptionInfo
)
{...}</code></pre><p>It is a pointer to <strong><a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_pointers"target="_blank" rel="external nofollow noopener noreferrer">EXCEPTION_POINTERS</a></strong> structure which contains the <strong><a href="https://learn.microsoft.com/en-us/windows/desktop/api/winnt/ns-winnt-exception_record"target="_blank" rel="external nofollow noopener noreferrer">ExceptionRecord</a></strong> and <strong><a href="https://learn.microsoft.com/en-us/windows/desktop/api/winnt/ns-winnt-context"target="_blank" rel="external nofollow noopener noreferrer">ContextRecord</a></strong>.</p>
<pre tabindex="0"><code>typedef struct _EXCEPTION_POINTERS {
  PEXCEPTION_RECORD ExceptionRecord;
  PCONTEXT          ContextRecord;
} EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;</code></pre><p>Now we have all the intrinsic details about it, and we can understand what goes within the <strong>Handler</strong> function. I&rsquo;m forcing an <strong>ACCESS_VIOLATION</strong> and using my <em>Handler</em> to take care of it; if it is the expected exception, I will change the <strong>EIP</strong> to my shellcode.</p>
<h3 class="heading-element" id="the-debugger-view"><span>The Debugger View</span>
  <a href="#the-debugger-view" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>The address of the shellcode in memory and in sequence the <strong>AddVectoredExceptionHandler</strong> function with the renamed <strong>veh_fn_handler</strong>
<figure><a class="lightgallery" href="/images/exceptionHandlers/x64dbg-shellcode-memory.png" title="Shellcode in memory" data-thumbnail="/images/exceptionHandlers/x64dbg-shellcode-memory.png" data-sub-html="<h2>x64dbg Shellcode in memory</h2><p>Shellcode in memory</p>"><img loading="lazy" src='/images/exceptionHandlers/x64dbg-shellcode-memory.png' alt="x64dbg Shellcode in memory" height="653" width="1655"></a><figcaption class="image-caption">Shellcode in memory</figcaption>
  </figure></p>
<p>When we arrive at the point where the null pointer would receive a value, we get the exception.
<figure><a class="lightgallery" href="/images/exceptionHandlers/x64fbg-access-violation.png" title="ACCESS_VIOLATION on x64dbg" data-thumbnail="/images/exceptionHandlers/x64fbg-access-violation.png" data-sub-html="<h2>x64dbg ACCESS_VIOLATION</h2><p>ACCESS_VIOLATION on x64dbg</p>"><img loading="lazy" src='/images/exceptionHandlers/x64fbg-access-violation.png' alt="x64dbg ACCESS_VIOLATION" height="570" width="1059"></a><figcaption class="image-caption">ACCESS_VIOLATION on x64dbg</figcaption>
  </figure></p>
<p>After that, pressing <strong>F9</strong> will reach our breakpoint on the <strong>veh_fn_handler</strong> and once more pressing <strong>F9</strong> we arrive at our <em>shellcode</em> by the <strong>EXCEPTION_SINGLE_STEP</strong>.</p>
<p><figure><a class="lightgallery" href="/images/exceptionHandlers/x64dbg-exception-message.png" title="Exception message" data-thumbnail="/images/exceptionHandlers/x64dbg-exception-message.png" data-sub-html="<h2>x64dbg Exception Message</h2><p>Exception message</p>"><img loading="lazy" src='/images/exceptionHandlers/x64dbg-exception-message.png' alt="x64dbg Exception Message" height="23" width="456"></a><figcaption class="image-caption">Exception message</figcaption>
  </figure></p>
<p>And finally :D
<figure><a class="lightgallery" href="/images/exceptionHandlers/x64dbg-shellcode.png" title="Shellcode on debugger" data-thumbnail="/images/exceptionHandlers/x64dbg-shellcode.png" data-sub-html="<h2>x64dbg shellcode</h2><p>Shellcode on debugger</p>"><img loading="lazy" src='/images/exceptionHandlers/x64dbg-shellcode.png' alt="x64dbg shellcode" height="193" width="1589"></a><figcaption class="image-caption">Shellcode on debugger</figcaption>
  </figure></p>
<h2 class="heading-element" id="conclusion"><span>Conclusion</span>
  <a href="#conclusion" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>The idea behind this post was to show a different approach used by some malware families to achieve their goals in a way that requires the analyst to spend some time flowing through the code to understand what is happening. With these simple examples, anyone interested in this can compile the code and take a look at the debugger and disassembler.</p>
<p>Reversing is mostly a case of practice! Do and repeat the process as much as you can until it starts to make sense.</p>
<p>I hope this post has been informative and useful to you. If you have any questions, doubts, or want to help me correct any mistakes, please feel free to contact me.</p>
<h2 class="heading-element" id="references"><span>References</span>
  <a href="#references" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><a href="https://en.wikipedia.org/wiki/Exception_handling"target="_blank" rel="external nofollow noopener noreferrer">https://en.wikipedia.org/wiki/Exception_handling</a></li>
<li><a href="https://learn.microsoft.com/en-us/cpp/cpp/structured-exception-handling-c-cpp?view=msvc-170#remarks"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/cpp/cpp/structured-exception-handling-c-cpp?view=msvc-170#remarks</a></li>
<li><a href="https://bytepointer.com/resources/pietrek_crash_course_depths_of_win32_seh.htm"target="_blank" rel="external nofollow noopener noreferrer">https://bytepointer.com/resources/pietrek_crash_course_depths_of_win32_seh.htm</a></li>
<li><a href="https://unprotect.it/technique/misusing-structured-exception-handlers/"target="_blank" rel="external nofollow noopener noreferrer">https://unprotect.it/technique/misusing-structured-exception-handlers/</a></li>
<li><a href="https://1malware1.medium.com/anti-disassembly-techniques-e012338f2ae0"target="_blank" rel="external nofollow noopener noreferrer">https://1malware1.medium.com/anti-disassembly-techniques-e012338f2ae0</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/debug/getexceptioninformation"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/debug/getexceptioninformation</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/debug/vectored-exception-handling"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/debug/vectored-exception-handling</a></li>
<li><a href="https://unprotect.it/technique/addvectoredexceptionhandler/"target="_blank" rel="external nofollow noopener noreferrer">https://unprotect.it/technique/addvectoredexceptionhandler/</a></li>
<li><a href="https://securityscorecard.com/research/deep-dive-into-alphv-blackcat-ransomware/"target="_blank" rel="external nofollow noopener noreferrer">https://securityscorecard.com/research/deep-dive-into-alphv-blackcat-ransomware/</a></li>
<li><a href="https://research.nccgroup.com/2022/03/01/detecting-anomalous-vectored-exception-handlers-on-windows/"target="_blank" rel="external nofollow noopener noreferrer">https://research.nccgroup.com/2022/03/01/detecting-anomalous-vectored-exception-handlers-on-windows/</a></li>
<li><a href="https://unit42.paloaltonetworks.com/guloader-variant-anti-analysis/"target="_blank" rel="external nofollow noopener noreferrer">https://unit42.paloaltonetworks.com/guloader-variant-anti-analysis/</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-addvectoredexceptionhandler"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-addvectoredexceptionhandler</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/nc-winnt-pvectored_exception_handler"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/winnt/nc-winnt-pvectored_exception_handler</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_pointers"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_pointers</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_record"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_record</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-context"target="_blank" rel="external nofollow noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-context</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Updated on 2024-06-26 18:20:43">Updated on 2024-06-26&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://moval0x1.github.io/posts/the-abuse-of-exception-handlers/" data-title="The Abuse of Exception Handlers" data-via="moval0x1" data-hashtags="Malware,Reversing"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://moval0x1.github.io/posts/the-abuse-of-exception-handlers/" data-hashtag="Malware"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://moval0x1.github.io/posts/the-abuse-of-exception-handlers/"><i class="fa-brands fa-linkedin fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://moval0x1.github.io/posts/the-abuse-of-exception-handlers/" data-title="The Abuse of Exception Handlers" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/malware/" class="post-tag" title="Tags - Malware">Malware</a><a href="/tags/reversing/" class="post-tag" title="Tags - Reversing">Reversing</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/qakbot-analysis/" class="post-nav-item" rel="prev" title="Qakbot Analysis"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Qakbot Analysis</a><a href="/posts/automating-tasks-with-x64dbg-scripts/" class="post-nav-item" rel="next" title="Automating Tasks With X64dbg Scripts">Automating Tasks With X64dbg Scripts<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.152.2"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.4.0-alpha.2-20251023040336-063af2cd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/about">moval0x1</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/posts/the-abuse-of-exception-handlers/config/page.js" defer></script><script src="/js/theme.min.js" defer></script></body>
</html>
