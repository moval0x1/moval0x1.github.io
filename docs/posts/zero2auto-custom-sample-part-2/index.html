<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Zero 2 Auto Custom Sample - Part 2 - The Reverser&#39;s Draft</title><meta name="author" content="moval0x1">
<meta name="description" content="Zero2Auto Custom Sample - Part 2"><meta name="keywords" content='Zero2Auto, Malware, Reversing'>
  <meta itemprop="name" content="Zero 2 Auto Custom sample - Part 2">
  <meta itemprop="description" content="Zero2Auto Custom Sample - Part 2">
  <meta itemprop="datePublished" content="2023-11-19T21:03:36+08:00">
  <meta itemprop="dateModified" content="2023-11-19T21:03:36+08:00">
  <meta itemprop="wordCount" content="1634">
  <meta itemprop="image" content="https://moval0x1.github.io/logo.png">
  <meta itemprop="keywords" content="Zero2Auto,Malware,Reversing"><meta property="og:url" content="https://moval0x1.github.io/posts/zero2auto-custom-sample-part-2/">
  <meta property="og:site_name" content="The Reverser&#39;s Draft">
  <meta property="og:title" content="Zero 2 Auto Custom sample - Part 2">
  <meta property="og:description" content="Zero2Auto Custom Sample - Part 2">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-19T21:03:36+08:00">
    <meta property="article:modified_time" content="2023-11-19T21:03:36+08:00">
    <meta property="article:tag" content="Zero2Auto">
    <meta property="article:tag" content="Malware">
    <meta property="article:tag" content="Reversing">
    <meta property="og:image" content="https://moval0x1.github.io/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://moval0x1.github.io/logo.png">
  <meta name="twitter:title" content="Zero 2 Auto Custom sample - Part 2">
  <meta name="twitter:description" content="Zero2Auto Custom Sample - Part 2">
      <meta name="twitter:site" content="@moval0x1">
<meta name="twitter:creator" content="@moval0x1" /><meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" type="text/html" href="https://moval0x1.github.io/posts/zero2auto-custom-sample-part-2/" title="Zero 2 Auto Custom sample - Part 2 - The Reverser&#39;s Draft" /><link rel="prev" type="text/html" href="https://moval0x1.github.io/posts/zero2auto-custom-sample-part-1/" title="Zero 2 Auto Custom sample - Part 1" /><link rel="next" type="text/html" href="https://moval0x1.github.io/posts/qakbot-analysis/" title="Qakbot Analysis" /><link rel="stylesheet" href="/css/config.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Zero 2 Auto Custom sample - Part 2",
    "inLanguage": "en-us",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/moval0x1.github.io\/posts\/zero2auto-custom-sample-part-2\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/moval0x1.github.io\/images\/profile.jpg",
              "width":  457 ,
              "height":  457 
            }],"genre": "posts","keywords": "Zero2Auto, Malware, Reversing","wordcount":  1634 ,
    "url": "https:\/\/moval0x1.github.io\/posts\/zero2auto-custom-sample-part-2\/","datePublished": "2023-11-19T21:03:36+08:00","dateModified": "2023-11-19T21:03:36+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "moval0x1"
      },"description": "Zero2Auto Custom Sample - Part 2"
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="The Reverser&#39;s Draft"><span class="header-title-text">The Reverser&#39;s Draft</span></a><span class="typeit header-subtitle"><template>Coding &amp; Malware &amp; Reverse Engineering</template></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/"><i class="fa-solid fa-file-lines fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a class="menu-link" href="/about/"><i class="fa-solid fa-solid fa-user fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="The Reverser&#39;s Draft"><span class="header-title-text">The Reverser&#39;s Draft</span></a><span class="typeit header-subtitle"><template>Coding &amp; Malware &amp; Reverse Engineering</template></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="menu-item"><a class="menu-link" href="/posts/"><i class="fa-solid fa-file-lines fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item"><a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item"><a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item"><a class="menu-link" href="/about/"><i class="fa-solid fa-solid fa-user fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="fi-container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Zero 2 Auto Custom Sample - Part 2</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="/about" title="Author" rel=" author" class="author"><img class="avatar" src='/images/profile.jpg' alt="moval0x1" height="16" width="16">&nbsp;moval0x1</a></span><span class="post-included-in">&nbsp;included in <a href="/categories/zero2auto/" class="post-category" title="Category - Zero2Auto"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Zero2Auto</a></span></div><div class="post-meta-line"><span title="published on 2023-11-19 21:03:36"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-11-19">2023-11-19</time></span>&nbsp;<span title="1634 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 1700 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>8 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#binary-ninja-plugin">Binary Ninja Plugin</a></li>
    <li><a href="#further-stages">Further Stages</a></li>
    <li><a href="#the-winner-debugger">The winner debugger</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="binary-ninja-plugin"><span>Binary Ninja Plugin</span>
  <a href="#binary-ninja-plugin" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>To start this second part of the custom sample analysis, I would like to add the script created using <a href="https://binary.ninja/"target="_blank" rel="external nofollow noopener noreferrer">Binary Ninja</a>. You can find the doc <a href="https://docs.binary.ninja/"target="_blank" rel="external nofollow noopener noreferrer">here</a>.</p>
<p>The script is not complex - if you have any suggestions to improve this, please share them with me :) - and it is probably not the fanciest code you have been seeing, but it is something that works, lol. It can be found on my <strong><a href="https://github.com/moval0x1/Zero2Auto/blob/main/zero2auto-custom-sample-decode.py"target="_blank" rel="external nofollow noopener noreferrer">Github</a></strong> page.</p>
<p>Here you can see how it works on <a href="https://binary.ninja/"target="_blank" rel="external nofollow noopener noreferrer">Binary Ninja</a>.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/BinaryNinja-Zero2Auto-Plugin.gif" title="Decode strings Binja Plugin" data-thumbnail="/images/zero2auto/2023-11-19/BinaryNinja-Zero2Auto-Plugin.gif" data-sub-html="<h2>Decode strings Binja Plugin</h2><p>Decode strings Binja Plugin</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/BinaryNinja-Zero2Auto-Plugin.gif' alt="Decode strings Binja Plugin" height="1182" width="2480"></a><figcaption class="image-caption">Decode strings Binja Plugin</figcaption>
  </figure></p>
<h2 class="heading-element" id="further-stages"><span>Further Stages</span>
  <a href="#further-stages" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Looking at the strings, I found something that caught my eye; there was a <strong><code>cruloader</code></strong> and it looked weird; maybe the name of this second part? Perhaps it&rsquo;s a joke? Who knows? I&rsquo;m assuming it is a part of the malware and not a joke.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/bn-cruloader.png" title="Cruloader" data-thumbnail="/images/zero2auto/2023-11-19/bn-cruloader.png" data-sub-html="<h2>Cruloader</h2><p>Cruloader</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/bn-cruloader.png' alt="Cruloader" height="478" width="699"></a><figcaption class="image-caption">Cruloader</figcaption>
  </figure></p>
<p>DiE tells us that we are dealing with a <strong><code>C/C++</code></strong> program.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/DiE-cruloader.png" title="DiE" data-thumbnail="/images/zero2auto/2023-11-19/DiE-cruloader.png" data-sub-html="<h2>DiE</h2><p>DiE</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/DiE-cruloader.png' alt="DiE" height="674" width="794"></a><figcaption class="image-caption">DiE</figcaption>
  </figure></p>
<p>Usually, when I have to deal with it, my first step is to go to the <strong><code>main</code></strong> function that usually for <strong><code>C/C++</code></strong> program can be found by three pushes before a call, something like that.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ASM" data-lang="ASM"><span style="display:flex;"><span><span style="color:#a6e22e">push</span> <span style="color:#66d9ef">something</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">push</span> <span style="color:#66d9ef">something</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">push</span> <span style="color:#66d9ef">something</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">call</span> <span style="color:#66d9ef">somethingElse</span></span></span></code></pre></div><p>I found the <strong><code>main</code></strong> function, it had an interesting part, and I can tell you why. After the <strong><code>GetModuleFileNameA</code></strong> which is responsible for: <strong>retrieve the fully qualified path for the file that contains the specified module.</strong> and the <strong><code>_strtok</code></strong> that is a kind of <strong>split</strong> function - until now, nothing new, right? - there is a function that compares with a hex value.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/bn-begin-main.png" title="Begin of main" data-thumbnail="/images/zero2auto/2023-11-19/bn-begin-main.png" data-sub-html="<h2>Begin of main</h2><p>Begin of main</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/bn-begin-main.png' alt="Begin of main" height="631" width="956"></a><figcaption class="image-caption">Begin of main</figcaption>
  </figure></p>
<p>Just after going inside this function, we have some values that we can use to search in Google - always a good idea to use Google to bring some insights to us. There are many occurences of the hex value <strong><code>0xedb88320</code></strong> with a <a href="https://www.geeksforgeeks.org/bitwise-operators-in-c-cpp/"target="_blank" rel="external nofollow noopener noreferrer">XOR</a> operation.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/bn-crc32.png" title="CRC32 function" data-thumbnail="/images/zero2auto/2023-11-19/bn-crc32.png" data-sub-html="<h2>CRC32 function</h2><p>CRC32 function</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/bn-crc32.png' alt="CRC32 function" height="666" width="956"></a><figcaption class="image-caption">CRC32 function</figcaption>
  </figure></p>
<p>One of the first results brings us the information that this is a <a href="https://lxp32.github.io/docs/a-simple-example-crc32-calculation/"target="_blank" rel="external nofollow noopener noreferrer">CRC32</a> implementation. To validate it, I will use the HashDB plugin from OALabs implemented on <a href="https://binary.ninja/"target="_blank" rel="external nofollow noopener noreferrer">Binary Ninja</a> by <a href="https://github.com/cxiao/hashdb_bn"target="_blank" rel="external nofollow noopener noreferrer">Cindy Xiao</a>, luckily it worked very well! &lt;3. I just renamed this function to <strong><code>mw_crc32</code></strong>. Because it is easier read names than random numbers.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/bn-hashdb-svchost.png" title="HashDB" data-thumbnail="/images/zero2auto/2023-11-19/bn-hashdb-svchost.png" data-sub-html="<h2>HashDB</h2><p>HashDB</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/bn-hashdb-svchost.png' alt="HashDB" height="330" width="1280"></a><figcaption class="image-caption">HashDB</figcaption>
  </figure></p>
<blockquote>
<p><strong>Just a comment here!</strong></p>
<p>The challenge could be easily resolved using <a href="https://github.com/x64dbg/x64dbg"target="_blank" rel="external nofollow noopener noreferrer">x64dbg</a>; the goal here is to use <a href="https://binary.ninja/"target="_blank" rel="external nofollow noopener noreferrer">Binary Ninja</a> to study the tool and also practice some static analysis to collect information as much as possible without debugging it.</p>
</blockquote>
<p>This part is so cool when we understand what is going on here. Look, this function resolves most of the content in run time, but it does not mean that we cannot understand the result without debugging it; basically, the malware gets this hex value and performs a loop, as shown on the left side. We can summarize it as:</p>
<ul>
<li>Get the char[i].</li>
<li>Rotate Left char[i] with 4.</li>
<li>XOR char[i] with 0xC5.</li>
</ul>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/bn-get-pastebin-url.png" title="Get Pastebin URL" data-thumbnail="/images/zero2auto/2023-11-19/bn-get-pastebin-url.png" data-sub-html="<h2>Get Pastebin URL</h2><p>Get Pastebin URL</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/bn-get-pastebin-url.png' alt="Get Pastebin URL" height="525" width="2286"></a><figcaption class="image-caption">Get Pastebin URL</figcaption>
  </figure></p>
<p>If we perform the same sequence mentioned previously, the magic happens and we get the Pastebin <strong><code>https[:]//pastebin[.]com/raw/mLem9DGk</code></strong>. I just used <a href="https://gchq.github.io/CyberChef/#recipe=From_Hex%28%27Auto%27%29Rotate_left%284,false%29XOR%28%7B%27option%27:%27Hex%27,%27string%27:%27c5%27%7D,%27Standard%27,false%29&amp;input=ZGExYjFiNWI2YmZmYWVhZTViNGE2YjFiMGE3YWNhYmFiZTZhYWE4YWFlN2I0YTJiYWU4YTk4MGE4YWNmMTgyOGVh"target="_blank" rel="external nofollow noopener noreferrer">CyberChef</a> to help me with that.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/cyberchef-pastebin-url.png" title="CyberChef Pastebin URL" data-thumbnail="/images/zero2auto/2023-11-19/cyberchef-pastebin-url.png" data-sub-html="<h2>CyberChef Pastebin URL</h2><p>CyberChef Pastebin URL</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/cyberchef-pastebin-url.png' alt="CyberChef Pastebin URL" height="472" width="1091"></a><figcaption class="image-caption">CyberChef Pastebin URL</figcaption>
  </figure></p>
<p>The content of Pastebin will be allocated - according to the APIs called after that. Taking a look at Pastebin, it only has another URL which points to this PNG file <strong><code>https[:]//i[.]ibb[.]co/KsfqHym/PNG-02-Copy[.]png</code></strong>. Nice, no? Unfortunately, no :/ Not everything is a flower in this awesome world of malware analysis. The image is corrupted, and it might be fixed before the &ldquo;execution?&rdquo;. It is my hypothesis.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/img-corrupted.png" title="Corrupted IMG" data-thumbnail="/images/zero2auto/2023-11-19/img-corrupted.png" data-sub-html="<h2>Corrupted IMG</h2><p>Corrupted IMG</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/img-corrupted.png' alt="Corrupted IMG" height="71" width="917"></a><figcaption class="image-caption">Corrupted IMG</figcaption>
  </figure></p>
<p>Following taking notes by static analysis, I found good things, and I kind of stayed stuck at some points, but let&rsquo;s keep moving until I got completely stuck. As mentioned before, sometimes I have renamed functions based on voices in my head, lol. To be honest, it is not this but essentially based on what I can understand by the function that I&rsquo;m analyzing. So, after a deep analysis, one of the functions needed to have its name changed. Mainly because I understood that it also decodes the corrupted file, and I will show you that.</p>
<p>The function named as <strong><code>mw_create_writeFile_temp</code></strong> now is called by <strong><code>mw_decode_create_writeFile_temp</code></strong>. Let&rsquo;s dig into it. I can explain almost the whole function without putting the binary on a debugger, but unfortunately, my static analysis skill is not as sharp as I intend to have it in the future - a short future, I hope. It starts by getting the content from Pastebin, performing one more time the <strong><code>rol 4 &gt; xor 0x1f</code></strong> sequence to decode the string <strong><code>.tuptuo\</code></strong>. This string looks reversed. Am I sure about that? No, yet, but if we reverse, it becomes <strong><code>/output.</code></strong>. After that, it performs another decode sequence - but this time, I cannot understand what the string means. I will see it and the other parts on the debugger; I&rsquo;m just pointing here what I&rsquo;ve found in the static analysis part.</p>
<p>At the end of performing some operations in a loop, after that, another loop with the <strong>IMG</strong> content <strong><code>XOR 0x61</code></strong>. When it finishes, the malware resolves some injection APIs, such as:</p>
<ul>
<li>CreateProcessA</li>
<li>WriteProcessMemory</li>
<li>ResumeThread</li>
<li>VirtualAllocEx</li>
<li>VirtualAlloc</li>
<li>CreateRemoteThread</li>
</ul>
<p>It looks like the malware will inject one more time content, keeping the analysis; the following function uses the same <strong><code>rol &gt; xor</code></strong> sequence to decode the full path of <a href="https://gchq.github.io/CyberChef/#recipe=From_Hex%28%27Auto%27%29Rotate_left%284,false%29XOR%28%7B%27option%27:%27Hex%27,%27string%27:%27a2%27%7D,%27Standard%27,false%29&amp;input=MWU4OWVmNWZiY2NjNmNkYzVkMWRlZjFmYmQxZDZkN2NmYzE5MDllZjFkNGQxY2FjZGMxZDZkYzg3Y2FkN2M"target="_blank" rel="external nofollow noopener noreferrer">svchost</a> <strong><code>C:\Windows\System32\svchost.exe</code></strong> and, at the end of this function, the last function is in charge of a Process Hollowing. How do I know that without debugging? Based on the APIs called, google is always my good friend, and it helped me find, for instance, this <a href="https://github.com/m0n0ph1/Process-Hollowing"target="_blank" rel="external nofollow noopener noreferrer">github</a> with a very close code as I found in the last function.</p>
<p>So far, so good. Now, let me validate all my hypotheses.</p>
<h2 class="heading-element" id="the-winner-debugger"><span>The winner debugger</span>
  <a href="#the-winner-debugger" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>As I started debugging, I just figured out that I forgot to see and renamed some functions, such as the first <strong><code>IsDebuggerPresent</code></strong> and the most important one, that is the <strong><code>CreateToolhelp32Snapshot</code></strong>. According to MSDN, this API <strong>takes a snapshot of the specified processes, as well as the heaps, modules, and threads used by these processes.</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>HANDLE <span style="color:#a6e22e">CreateToolhelp32Snapshot</span>(
</span></span><span style="display:flex;"><span>  [in] DWORD dwFlags,
</span></span><span style="display:flex;"><span>  [in] DWORD th32ProcessID
</span></span><span style="display:flex;"><span>);</span></span></code></pre></div><p>It will take a &ldquo;photo&rdquo; of the process list and loop through it searching for something, in our case, something hashed by CRC32. I could easily bypass this function result by changing the Zero Flag or the Jump below the comparison, but I&rsquo;m here to learn more and dig deep into the challenge. Let&rsquo;s debug it! :)</p>
<p>I found that when it compares <strong><code>EAX</code></strong> with <strong><code>0x7C6FFE70</code></strong> it returns the wrong result, so let me identify what this value is - I know that it uses a CRC32 implementation, and I will use it to my advantage.</p>
<p>As it spends some time in the loop, I will use a <a href="https://help.x64dbg.com/en/latest/introduction/ConditionalBreakpoint.html"target="_blank" rel="external nofollow noopener noreferrer">Conditional BreakPoint</a> to only break when it is <strong><code>explorer.exe</code></strong> because malware authors, usually use this function to validate the processes running to close an analysis application or close the process itself if find any weird stuff, I will start there, I would not spend too much time on this loop, to be honest.</p>
<p>I just added this beautiful line <strong><code>strstr(utf16(ESI), &quot;explorer.exe&quot;)</code></strong> on this line and executed my program. Easy no?</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/x64dbg-conditional-bp.png" title="Conditional BreakPoint" data-thumbnail="/images/zero2auto/2023-11-19/x64dbg-conditional-bp.png" data-sub-html="<h2>Conditional BreakPoint</h2><p>Conditional BreakPoint</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/x64dbg-conditional-bp.png' alt="Conditional BreakPoint" height="289" width="571"></a><figcaption class="image-caption">Conditional BreakPoint</figcaption>
  </figure></p>
<p>And it worked!</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/x64dbg-bp-explorer-exe.png" title="BreakPoint on explorer.exe" data-thumbnail="/images/zero2auto/2023-11-19/x64dbg-bp-explorer-exe.png" data-sub-html="<h2>BreakPoint on explorer.exe</h2><p>BreakPoint on explorer.exe</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/x64dbg-bp-explorer-exe.png' alt="BreakPoint on explorer.exe" height="83" width="1725"></a><figcaption class="image-caption">BreakPoint on explorer.exe</figcaption>
  </figure></p>
<p>I got two programs that I opened to analyze the binary, and both of them were searched by the malware; one of them was <strong><code>ProceessHacker.exe</code></strong> with the hash <strong><code>0x7C6FFE70</code></strong>.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/x64dbg-processHacker.png" title="ProcessHacker x64dbg" data-thumbnail="/images/zero2auto/2023-11-19/x64dbg-processHacker.png" data-sub-html="<h2>ProcessHacker x64dbg</h2><p>ProcessHacker x64dbg</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/x64dbg-processHacker.png' alt="ProcessHacker x64dbg" height="167" width="504"></a><figcaption class="image-caption">ProcessHacker x64dbg</figcaption>
  </figure></p>
<p>After closes them I got <strong><code>x32dbg.exe</code></strong> with the hash <strong><code>0xD2F05B7D</code></strong>.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/x64dbg-x32dbg-process.png" title="x32dbg process" data-thumbnail="/images/zero2auto/2023-11-19/x64dbg-x32dbg-process.png" data-sub-html="<h2>x32dbg process</h2><p>x32dbg process</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/x64dbg-x32dbg-process.png' alt="x32dbg process" height="168" width="505"></a><figcaption class="image-caption">x32dbg process</figcaption>
  </figure></p>
<p>As I changed the name of my debugger to <strong><code>moval0x1.exe</code></strong> I was able to continue without further problems. I have to admit that some tasks are easier with debugger than just open in a disassembly and try to understand without dynamicaly run.</p>
<p>The malware download the <strong><code>.PNG</code></strong> file, get the size using <strong><code>HttpQueryInfoA</code></strong> with <strong><code>dwInfoLevel</code></strong> being passed 5, which means <strong><code>HTTP_QUERY_CONTENT_LENGTH</code></strong>.</p>
<blockquote>
<p>Retrieves the size of the resource, in bytes.</p>
</blockquote>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/x64dbg-output-jpg.png" title="output.jpg" data-thumbnail="/images/zero2auto/2023-11-19/x64dbg-output-jpg.png" data-sub-html="<h2>output.jpg</h2><p>output.jpg</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/x64dbg-output-jpg.png' alt="output.jpg" height="168" width="522"></a><figcaption class="image-caption">output.jpg</figcaption>
  </figure></p>
<p>I saw the <strong>cruloader</strong> string, but I didn&rsquo;t catch the idea behind it debugging. I got that it concat with the temp folder to save the output; it also uses <a href="https://isc.sans.edu/diary/Stackstrings&#43;type&#43;2/26192/"target="_blank" rel="external nofollow noopener noreferrer">stackstring</a> to disrupt our analysis.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/x64dbg-cruloader-temp-folder.png" title="Create file" data-thumbnail="/images/zero2auto/2023-11-19/x64dbg-cruloader-temp-folder.png" data-sub-html="<h2>Create file</h2><p>Create file</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/x64dbg-cruloader-temp-folder.png' alt="Create file" height="78" width="2343"></a><figcaption class="image-caption">Create file</figcaption>
  </figure></p>
<p>The magic of learning and reading about APIs, after the folder has been created, we have a <strong><code>WriteFile</code></strong> telling us everything we need to know.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">WriteFile</span>(
</span></span><span style="display:flex;"><span>  [in]                HANDLE       hFile,
</span></span><span style="display:flex;"><span>  [in]                LPCVOID      lpBuffer,
</span></span><span style="display:flex;"><span>  [in]                DWORD        nNumberOfBytesToWrite,
</span></span><span style="display:flex;"><span>  [out, optional]     LPDWORD      lpNumberOfBytesWritten,
</span></span><span style="display:flex;"><span>  [in, out, optional] LPOVERLAPPED lpOverlapped
</span></span><span style="display:flex;"><span>);</span></span></code></pre></div><p>Based on that, we can see that the handle is <strong><code>0x470</code></strong>, the content to be written is at the address <strong><code>0x03740000</code></strong>, and the length is <strong><code>0x435B8</code></strong>. It means that the entire file will be written on disk.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/x64dbg-writefile.png" title="WriteFile API" data-thumbnail="/images/zero2auto/2023-11-19/x64dbg-writefile.png" data-sub-html="<h2>WriteFile API</h2><p>WriteFile API</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/x64dbg-writefile.png' alt="WriteFile API" height="202" width="1540"></a><figcaption class="image-caption">WriteFile API</figcaption>
  </figure></p>
<p>And one more time it gets a reverse string, <strong><code>redaolurc</code></strong> that is the same <strong><code>cruloader</code></strong> and it is find inside the <strong><code>.PNG</code></strong> as we can see below.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/wxHex-PNG.png" title="wxHexEditor" data-thumbnail="/images/zero2auto/2023-11-19/wxHex-PNG.png" data-sub-html="<h2>wxHexEditor</h2><p>wxHexEditor</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/wxHex-PNG.png' alt="wxHexEditor" height="775" width="1543"></a><figcaption class="image-caption">wxHexEditor</figcaption>
  </figure></p>
<p>Ok, but, why this information is useful? That&rsquo;s a good question! The answer is some lines below. The malware reads the content of the <strong><code>.PNG</code></strong> search for the reverse <strong>cruloader</strong> string and everything after that should be <strong><code>XORed</code></strong> with <strong><code>0x61</code></strong>, the image is a Zero2Auto logo and it was used to deceive the first seen of the file. We can see in the image below that it kind of worked.</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/fi-xored-png.png" title="XORed PNG" data-thumbnail="/images/zero2auto/2023-11-19/fi-xored-png.png" data-sub-html="<h2>XORed PNG</h2><p>XORed PNG</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/fi-xored-png.png' alt="XORed PNG" height="411" width="1026"></a><figcaption class="image-caption">XORed PNG</figcaption>
  </figure></p>
<p>After that, we know that the Process Hollowing is coming. Probably I missed something because the binary showed me some congratulations strings but didn&rsquo;t run - maybe my &ldquo;smart&rdquo; moment in just trying to perform the <strong><code>XOR</code></strong> was not enough. To finish it, taking a look at the renamed function <strong><code>mw_processHollowing</code></strong> I just passed all steps as I did previously, and before the malware <strong><code>ResumeThread</code></strong> I dumped the injected file on <strong><code>svchost.txt</code></strong> and fixed the imports - by the way, there was an organized mess :D</p>
<p>And finally, there is this beautiful message here!</p>
<p><figure><a class="lightgallery" href="/images/zero2auto/2023-11-19/cruloader-messagebox.png" title="Cruloader MessageBox" data-thumbnail="/images/zero2auto/2023-11-19/cruloader-messagebox.png" data-sub-html="<h2>Cruloader MessageBox</h2><p>Cruloader MessageBox</p>"><img loading="lazy" src='/images/zero2auto/2023-11-19/cruloader-messagebox.png' alt="Cruloader MessageBox" height="187" width="618"></a><figcaption class="image-caption">Cruloader MessageBox</figcaption>
  </figure></p>
<p>Thank you for reading! It was a really fun challenge.</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod"><span title="Updated on 2023-11-19 21:03:36">Updated on 2023-11-19&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://moval0x1.github.io/posts/zero2auto-custom-sample-part-2/" data-title="Zero 2 Auto Custom Sample - Part 2" data-via="moval0x1" data-hashtags="Zero2Auto,Malware,Reversing"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://moval0x1.github.io/posts/zero2auto-custom-sample-part-2/" data-hashtag="Zero2Auto"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://moval0x1.github.io/posts/zero2auto-custom-sample-part-2/"><i class="fa-brands fa-linkedin fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://moval0x1.github.io/posts/zero2auto-custom-sample-part-2/" data-title="Zero 2 Auto Custom Sample - Part 2" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/zero2auto/" class="post-tag" title="Tags - Zero2Auto">Zero2Auto</a><a href="/tags/malware/" class="post-tag" title="Tags - Malware">Malware</a><a href="/tags/reversing/" class="post-tag" title="Tags - Reversing">Reversing</a></section>
    <section><span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/zero2auto-custom-sample-part-1/" class="post-nav-item" rel="prev" title="Zero 2 Auto Custom Sample - Part 1"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Zero 2 Auto Custom Sample - Part 1</a><a href="/posts/qakbot-analysis/" class="post-nav-item" rel="next" title="Qakbot Analysis">Qakbot Analysis<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.152.2"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.4.0-alpha.2-20251023040336-063af2cd"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/about">moval0x1</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/posts/zero2auto-custom-sample-part-2/config/page.js" defer></script><script src="/js/theme.min.js" defer></script></body>
</html>
